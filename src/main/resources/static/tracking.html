<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ride Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        body { background-color: transparent; color: #000000; }
        #map { height: 600px; width: 100%; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: transparent; }
        .info-box { padding: 16px; background: transparent; border: none; margin-bottom: 20px; border-radius: 12px; box-shadow: none; }
        .highlight { font-weight: bold; color: #f97316; font-size: 18px; }
        .animate-fade { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        button:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .leaflet-routing-container { display: none; } /* Hide the default routing control panel */
    </style>
</head>
<body class="p-6 bg-transparent">
<div class="max-w-md mx-auto bg-transparent p-6">
    <h2 class="text-3xl font-bold mb-6 text-center text-black">Ride Tracking</h2>

    <!-- Map -->
    <div id="map"></div>

    <!-- Ride Info -->
    <div class="info-box animate-fade">
        <p>Ride ID: <span id="rideId" class="highlight"></span></p>
        <p>Status: <span id="status" class="highlight"></span></p>
        <p>Pickup: <span id="pickupLoc" class="highlight"></span></p>
        <p>Dropoff: <span id="dropoffLoc" class="highlight"></span></p>
        <p>Distance: <span id="distance" class="highlight"></span> km</p>
    </div>

    <!-- Action Buttons -->
    <button id="updateLocationBtn" class="w-full bg-orange-500 text-white p-3 rounded-lg mb-3 hover:bg-orange-600 font-semibold shadow-md animate-fade">Update Location</button>
    <button id="cancelRideBtn" class="w-full bg-orange-500 text-white p-3 rounded-lg hover:bg-orange-600 font-semibold shadow-md animate-fade">Cancel Ride</button>
    <p id="message" class="mt-4 text-center text-orange-500 font-medium animate-fade"></p>
</div>

<script>
    let map, driverMarkers = [], rideId, pickup, dropoff, routeLayer, vehicleMarker, routeCoords = [], routingControl, selectedVehicleType;
    const geoapifyApiKey = '9efd1d5a33794a978148be1526c83da6';

    function initMap() {
        const urlParams = new URLSearchParams(window.location.search);
        rideId = urlParams.get('rideId');
        if (!rideId) {
            document.getElementById('message').textContent = 'No ride ID provided';
            return;
        }
        pickup = urlParams.get('pickup')?.split(',').map(Number) || [6.9271, 79.8612];
        dropoff = urlParams.get('dropoff')?.split(',').map(Number) || [6.9271, 79.8612];
        selectedVehicleType = urlParams.get('vehicleType') || 'car'; // Default to 'car' if not provided

        map = L.map('map', { attributionControl: false }).setView([(pickup[0] + dropoff[0]) / 2, (pickup[1] + dropoff[1]) / 2], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);

        const pickupMarker = L.marker(pickup, { icon: L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', iconSize: [32, 32] }) }).addTo(map).bindPopup('Pickup').openPopup();
        const dropoffMarker = L.marker(dropoff, { icon: L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize: [32, 32] }) }).addTo(map).bindPopup('Dropoff').openPopup();
        map.fitBounds([pickup, dropoff]);

        routingControl = L.Routing.control({
            waypoints: [L.latLng(pickup[0], pickup[1]), L.latLng(dropoff[0], dropoff[1])],
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
            lineOptions: {
                styles: [{ color: 'blue', weight: 5, opacity: 0.8 }]
            },
            show: false,
            addWaypoints: false,
            routeWhileDragging: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            createMarker: function() { return null; }
        }).addTo(map);

        routingControl.on('routesfound', function(e) {
            const route = e.routes[0];
            document.getElementById('distance').textContent = (route.summary.totalDistance / 1000).toFixed(2);
            routeCoords = route.coordinates;
        });

        document.getElementById('rideId').textContent = rideId;
        simulateDriverAcceptance();
        fetchAvailableDrivers();
        updateLocations();
    }

    function simulateDriverAcceptance() {
        setTimeout(() => {
            if (Math.random() > 0.3) {
                fetch(`/api/rides/${rideId}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('status').textContent = data.status || 'Accepted';
                        if (data.status === 'Accepted') simulateVehicleMovement();
                    });
            } else {
                document.getElementById('message').textContent = 'No driver accepted yet. Retrying...';
                setTimeout(simulateDriverAcceptance, 5000);
            }
        }, 2000);
    }

    async function fetchAvailableDrivers() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    const url = `/api/rides/available-drivers?pickupLocation=${latitude},${longitude}`;
                    try {
                        const response = await fetch(url);
                        const drivers = await response.json();
                        const vehicleCount = Math.max(5, Math.min(10, drivers.length));
                        driverMarkers.forEach(marker => map.removeLayer(marker));
                        driverMarkers = [];
                        for (let i = 0; i < vehicleCount; i++) {
                            const lat = latitude + (Math.random() - 0.5) * 0.1;
                            const lng = longitude + (Math.random() - 0.5) * 0.1;
                            let vehicleIcon;
                            if (selectedVehicleType === 'bike') {
                                vehicleIcon = L.icon({ iconUrl: '/image/Bike.jpg', iconSize: [32, 32] });
                            } else if (selectedVehicleType === 'car') {
                                vehicleIcon = L.icon({ iconUrl: '/image/car.jpg', iconSize: [32, 32] });
                            } else if (selectedVehicleType === 'auto') {
                                vehicleIcon = L.icon({ iconUrl: '/image/Auto.jpg', iconSize: [32, 32] });
                            }
                            if (vehicleIcon) {
                                const marker = L.marker([lat, lng], { icon: vehicleIcon }).addTo(map);
                                driverMarkers.push(marker);
                            }
                        }
                    } catch (e) { console.error(e); }
                },
                (error) => console.error("Error getting location:", error)
            );
        }
    }

    async function updateLocations() {
        const fetchLocation = async (lat, lng) => {
            const url = `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${geoapifyApiKey}`;
            const res = await fetch(url);
            const data = await res.json();
            return data.features?.length ? data.features[0].properties.formatted : 'Unknown';
        };
        const pickupLoc = await fetchLocation(pickup[0], pickup[1]);
        const dropoffLoc = await fetchLocation(dropoff[0], dropoff[1]);
        document.getElementById('pickupLoc').textContent = pickupLoc;
        document.getElementById('dropoffLoc').textContent = dropoffLoc;
    }

    function simulateVehicleMovement() {
        if (routeCoords.length === 0) return;
        let vehicleIcon;
        if (selectedVehicleType === 'bike') {
            vehicleIcon = L.icon({ iconUrl: '/image/Bike.jpg', iconSize: [32, 32] });
        } else if (selectedVehicleType === 'car') {
            vehicleIcon = L.icon({ iconUrl: '/image/car.jpg', iconSize: [32, 32] });
        } else if (selectedVehicleType === 'auto') {
            vehicleIcon = L.icon({ iconUrl: '/image/Auto.jpg', iconSize: [32, 32] });
        }
        vehicleMarker = L.marker(routeCoords[0], { icon: vehicleIcon }).addTo(map);
        let index = 0;
        const interval = setInterval(() => {
            index++;
            if (index >= routeCoords.length) {
                clearInterval(interval);
                document.getElementById('status').textContent = 'Completed';
                return;
            }
            vehicleMarker.setLatLng(routeCoords[index]);
        }, 1000);
    }

    document.getElementById('updateLocationBtn').addEventListener('click', () => {
        if (!rideId) {
            document.getElementById('message').textContent = 'No ride ID to update';
            return;
        }
        window.location.href = `updateLocation.html?rideId=${rideId}&pickup=${pickup.join(',')}&dropoff=${dropoff.join(',')}`;
    });

    document.getElementById('cancelRideBtn').addEventListener('click', () => {
        if (!rideId) {
            document.getElementById('message').textContent = 'No ride ID to cancel';
            return;
        }
        if (confirm('Are you sure you want to cancel the ride?')) {
            fetch(`/api/rides/cancel/${rideId}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        document.getElementById('status').textContent = 'Cancelled';
                        document.getElementById('updateLocationBtn').disabled = true;
                        document.getElementById('cancelRideBtn').disabled = true;
                        document.getElementById('message').textContent = 'Ride cancelled successfully';
                        setTimeout(() => window.location.href = 'ride-booking.html', 2000);
                    } else {
                        document.getElementById('message').textContent = 'Error cancelling ride';
                    }
                })
                .catch(e => {
                    document.getElementById('message').textContent = 'Error cancelling ride';
                    console.error(e);
                });
        }
    });

    initMap();
</script>
</body>
</html>